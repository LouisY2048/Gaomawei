<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>去中心化交易所</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        h2 {
            color: #333;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .error {
            color: red;
            margin-top: 5px;
        }
        .success {
            color: green;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>去中心化交易所</h1>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <span></span>
            <div>
                <button id="connectWallet" style="margin-left: auto;">连接 MetaMask</button>
                <span id="walletAddress"></span>
            </div>
        </div>

        <div class="section">
            <h2>添加流动性</h2>
            <div class="form-group">
                <label>Token0 数量:</label>
                <input type="number" id="amount0" placeholder="输入数量" onblur="calculateFromToken0()">
            </div>
            <div class="form-group">
                <label>Token1 数量:</label>
                <input type="number" id="amount1" placeholder="输入数量" onblur="calculateFromToken1()">
            </div>
            <button id="addLiquidity">添加流动性</button>
            <div id="addLiquidityResult"></div>
        </div>

        <div class="section">
            <h2>移除流动性</h2>
            <div class="form-group">
                <label>LP Token 数量:</label>
                <input type="number" id="removeAmount" placeholder="输入数量">
            </div>
            <button id="removeLiquidity">移除流动性</button>
            <div id="removeLiquidityResult"></div>
        </div>

        <div class="section">
            <h2>代币交换</h2>
            <div class="form-group">
                <label>输入代币数量:</label>
                <input type="number" id="swapAmount" placeholder="输入数量">
            </div>
            <div class="form-group">
                <label>选择输入代币:</label>
                <select id="tokenIn">
                    <option value="token0">Token0</option>
                    <option value="token1">Token1</option>
                </select>
            </div>
            <button id="swap">交换</button>
            <div id="swapResult"></div>
        </div>

        <div class="section">
            <h2>池子信息</h2>
            <div id="poolInfo"></div>
        </div>
    </div>

    <script>
        // 等待 ethers 加载完成
        window.addEventListener('load', function() {
            if (typeof ethers === 'undefined') {
                console.error('ethers 库加载失败');
                document.getElementById('walletAddress').innerHTML = 
                    '<div class="error">ethers 库加载失败，请刷新页面重试</div>';
                return;
            }
        });

        // 合约地址和 ABI 需要部署后更新
        let POOL_ADDRESS, TOKEN0_ADDRESS, TOKEN1_ADDRESS;
        
        // 加载合约地址
        async function loadContractAddresses() {
            try {
                const response = await fetch('./contract-addresses.json');
                if (!response.ok) {
                    throw new Error(`HTTP 错误! 状态: ${response.status}`);
                }
                
                const contractAddresses = await response.json();
                POOL_ADDRESS = contractAddresses.pool;
                TOKEN0_ADDRESS = contractAddresses.token0;
                TOKEN1_ADDRESS = contractAddresses.token1;
                
                console.log('已加载合约地址:', {
                    pool: POOL_ADDRESS,
                    token0: TOKEN0_ADDRESS,
                    token1: TOKEN1_ADDRESS
                });
            } catch (error) {
                console.error('加载合约地址失败:', error);
                throw error;
            }
        }

        let provider, signer, poolContract, token0Contract, token1Contract;
        let userAddress;

        // 定义 ABI
        const poolABI = [
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount0",
                        "type": "uint256"
                    }
                ],
                "name": "addLiquidity",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getReserves",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount0",
                        "type": "uint256"
                    }
                ],
                "name": "getRequiredAmount1",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "lpAmount",
                        "type": "uint256"
                    }
                ],
                "name": "removeLiquidity",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "tokenIn",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "amountIn",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "tokenOut",
                        "type": "address"
                    }
                ],
                "name": "swap",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "account",
                        "type": "address"
                    }
                ],
                "name": "balanceOf",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];
        
        const tokenABI = [
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "spender",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "value",
                        "type": "uint256"
                    }
                ],
                "name": "approve",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "account",
                        "type": "address"
                    }
                ],
                "name": "balanceOf",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "spender",
                        "type": "address"
                    }
                ],
                "name": "allowance",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // 初始化应用
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 检查是否安装了 MetaMask
                if (typeof window.ethereum === 'undefined') {
                    document.getElementById('walletAddress').innerHTML = 
                        '<div class="error">请安装 MetaMask 钱包</div>';
                    return;
                }

                // 添加网络变化监听器
                window.ethereum.on('chainChanged', () => {
                    console.log('网络已变化，重新加载页面...');
                    window.location.reload();
                });

                // 添加账户变化监听器
                window.ethereum.on('accountsChanged', (accounts) => {
                    console.log('账户已变化，重新加载页面...');
                    window.location.reload();
                });
            } catch (error) {
                console.error('初始化失败:', error);
                document.getElementById('walletAddress').innerHTML = 
                    `<div class="error">初始化失败: ${error.message}</div>`;
            }
        });

        // 连接钱包
        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    console.log('开始连接钱包...');
                    
                    // 添加网络变化监听器
                    window.ethereum.on('chainChanged', () => {
                        console.log('网络已变化，重新加载页面...');
                        window.location.reload();
                    });
                    
                    // 添加账户变化监听器
                    window.ethereum.on('accountsChanged', () => {
                        console.log('账户已变化，重新加载页面...');
                        window.location.reload();
                    });
                    
                    // 加载合约地址
                    console.log('加载合约地址...');
                    await loadContractAddresses();
                    
                    // 请求用户授权
                    console.log('请求用户授权...');
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    // 检查网络
                    const network = await window.ethereum.request({ method: 'eth_chainId' });
                    if (network !== '0x7a69') { // 31337 in hex
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x7a69' }], // Hardhat 本地网络
                            });
                        } catch (error) {
                            console.error('切换网络失败:', error);
                            throw new Error('请切换到 Hardhat 本地网络 (chainId: 31337)');
                        }
                    }
                    
                    // 创建 provider
                    console.log('创建 provider...');
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    
                    // 获取 signer
                    console.log('获取 signer...');
                    signer = provider.getSigner();
                    
                    // 获取用户地址
                    userAddress = await signer.getAddress();
                    console.log('用户地址:', userAddress);
                    
                    // 显示连接成功信息
                    document.getElementById('walletAddress').innerHTML = 
                        `<div class="success">已连接钱包: ${userAddress}</div>`;
                    
                    // 初始化合约
                    console.log('初始化合约...');
                    await initializeContracts();
                } else {
                    throw new Error('请安装 MetaMask!');
                }
            } catch (error) {
                console.error('连接钱包失败:', error);
                document.getElementById('walletAddress').innerHTML = 
                    `<div class="error">连接钱包失败: ${error.message}</div>`;
            }
        }

        // 初始化合约
        async function initializeContracts() {
            try {
                console.log('创建合约实例...');
                
                // 检查地址有效性
                if (!ethers.utils.isAddress(POOL_ADDRESS) || 
                    !ethers.utils.isAddress(TOKEN0_ADDRESS) || 
                    !ethers.utils.isAddress(TOKEN1_ADDRESS)) {
                    throw new Error('无效的合约地址');
                }

                // 使用 signer 而不是 provider 创建合约实例
                poolContract = new ethers.Contract(POOL_ADDRESS, poolABI, signer);
                token0Contract = new ethers.Contract(TOKEN0_ADDRESS, tokenABI, signer);
                token1Contract = new ethers.Contract(TOKEN1_ADDRESS, tokenABI, signer);
                
                console.log('合约地址:', {
                    pool: POOL_ADDRESS,
                    token0: TOKEN0_ADDRESS,
                    token1: TOKEN1_ADDRESS
                });
                
                console.log('合约实例创建完成');
                
                // 更新池子信息
                await updatePoolInfo();
            } catch (error) {
                console.error('初始化合约失败:', error);
                throw error;
            }
        }

        // 从 Token0 计算 Token1 数量
        async function calculateFromToken0() {
            try {
                const amount0Str = document.getElementById('amount0').value;
                
                // 基本输入验证
                if (!amount0Str || isNaN(amount0Str) || parseFloat(amount0Str) <= 0) {
                    document.getElementById('amount1').value = '';
                    return;
                }
                
                if (!poolContract) {
                    console.log('合约未初始化，无法计算Token1数量');
                    return;
                }
                
                const amount0 = ethers.utils.parseEther(amount0Str);
                console.log('计算 Token1 数量，Token0 输入:', amount0Str, '(Wei:', amount0.toString(), ')');
                
                // 调用合约的 getRequiredAmount1 方法
                const requiredAmount1 = await poolContract.getRequiredAmount1(amount0);
                const requiredAmount1Str = ethers.utils.formatEther(requiredAmount1);
                
                console.log('所需 Token1 数量:', requiredAmount1Str, '(Wei:', requiredAmount1.toString(), ')');
                
                // 设置 Token1 输入框
                document.getElementById('amount1').value = requiredAmount1Str;
            } catch (error) {
                console.error('计算 Token1 数量失败:', error);
            }
        }

        // 从 Token1 计算 Token0 数量（需要通过反向计算）
        async function calculateFromToken1() {
            try {
                const amount1Str = document.getElementById('amount1').value;
                
                // 基本输入验证
                if (!amount1Str || isNaN(amount1Str) || parseFloat(amount1Str) <= 0) {
                    document.getElementById('amount0').value = '';
                    return;
                }
                
                if (!poolContract) {
                    console.log('合约未初始化，无法计算Token0数量');
                    return;
                }
                
                const amount1 = ethers.utils.parseEther(amount1Str);
                console.log('计算 Token0 数量，Token1 输入:', amount1Str, '(Wei:', amount1.toString(), ')');
                
                // 获取池子当前储备
                const [reserve0, reserve1] = await poolContract.getReserves();
                
                // 如果池子没有储备，使用初始比例（token0:token1 = 1:2）
                if (reserve0.isZero() || reserve1.isZero()) {
                    const amount0 = amount1.div(2); // 假设初始比例为 1:2
                    const amount0Str = ethers.utils.formatEther(amount0);
                    console.log('池子为空，使用初始比例 1:2，所需 Token0 数量:', amount0Str, '(Wei:', amount0.toString(), ')');
                    document.getElementById('amount0').value = amount0Str;
                    return;
                }
                
                // 根据池子当前比例计算所需的 Token0 数量
                // amount0 = amount1 * reserve0 / reserve1
                const amount0 = amount1.mul(reserve0).div(reserve1);
                const amount0Str = ethers.utils.formatEther(amount0);
                
                console.log('所需 Token0 数量:', amount0Str, '(Wei:', amount0.toString(), ')');
                
                // 设置 Token0 输入框
                document.getElementById('amount0').value = amount0Str;
            } catch (error) {
                console.error('计算 Token0 数量失败:', error);
            }
        }

        // 计算 Token1 数量（为了兼容旧代码）
        async function calculateToken1Amount() {
            return calculateFromToken0();
        }

        // 添加流动性
        async function addLiquidity() {
            try {
                console.log('===== 开始添加流动性流程 =====');
                const amount0Str = document.getElementById('amount0').value;
                const amount1Str = document.getElementById('amount1').value;
                
                // 基本输入验证
                if (!amount0Str || isNaN(amount0Str) || parseFloat(amount0Str) <= 0) {
                    throw new Error('请输入有效的 Token0 数量');
                }
                
                if (!amount1Str || isNaN(amount1Str) || parseFloat(amount1Str) <= 0) {
                    throw new Error('请计算所需的 Token1 数量');
                }
                
                const amount0 = ethers.utils.parseEther(amount0Str);
                const amount1 = ethers.utils.parseEther(amount1Str);
                
                console.log('Token0 数量:', amount0Str, '(Wei:', amount0.toString(), ')');
                console.log('Token1 数量:', amount1Str, '(Wei:', amount1.toString(), ')');
                
                // 重新计算一次，确保数量正确
                const requiredAmount1 = await poolContract.getRequiredAmount1(amount0);
                
                // 如果计算出的 amount1 与显示的不符，可能是用户修改了输入框或计算过程中合约状态发生变化
                if (!requiredAmount1.eq(amount1)) {
                    console.warn('计算的 Token1 数量与显示的不一致，更新显示');
                    document.getElementById('amount1').value = ethers.utils.formatEther(requiredAmount1);
                    
                    // 更新本地变量
                    const newAmount1Str = ethers.utils.formatEther(requiredAmount1);
                    console.log('更新 Token1 数量:', newAmount1Str, '(Wei:', requiredAmount1.toString(), ')');
                }

                // 检查代币余额
                console.log('检查 Token0 余额...');
                const balance0 = await token0Contract.balanceOf(userAddress);
                console.log('Token0 余额:', ethers.utils.formatEther(balance0), '(Wei:', balance0.toString(), ')');
                
                console.log('检查 Token1 余额...');
                const balance1 = await token1Contract.balanceOf(userAddress);
                console.log('Token1 余额:', ethers.utils.formatEther(balance1), '(Wei:', balance1.toString(), ')');

                if (balance0.lt(amount0)) {
                    throw new Error(`Token0 余额不足 (当前余额: ${ethers.utils.formatEther(balance0)} T0, 需要: ${amount0Str} T0)`);
                }
                if (balance1.lt(requiredAmount1)) {
                    throw new Error(`Token1 余额不足 (当前余额: ${ethers.utils.formatEther(balance1)} T1, 需要: ${ethers.utils.formatEther(requiredAmount1)} T1)`);
                }

                // 检查授权额度
                console.log('检查 Token0 授权额度...');
                const allowance0 = await token0Contract.allowance(userAddress, POOL_ADDRESS);
                console.log('Token0 授权额度:', ethers.utils.formatEther(allowance0), '(Wei:', allowance0.toString(), ')');
                
                console.log('检查 Token1 授权额度...');
                const allowance1 = await token1Contract.allowance(userAddress, POOL_ADDRESS);
                console.log('Token1 授权额度:', ethers.utils.formatEther(allowance1), '(Wei:', allowance1.toString(), ')');

                // Token0 授权
                if (allowance0.lt(amount0)) {
                    console.log('正在授权 Token0...');
                    document.getElementById('addLiquidityResult').innerHTML = 
                        '<div class="info">请在 MetaMask 中确认 Token0 授权...</div>';
                    
                    try {
                        const approveTx0 = await token0Contract.approve(POOL_ADDRESS, amount0, {
                            gasLimit: 100000
                        });
                        console.log('Token0 授权交易已发送:', approveTx0.hash);
                        
                        document.getElementById('addLiquidityResult').innerHTML = 
                            '<div class="info">Token0 授权中，请等待确认...</div>';
                        
                        const receipt0 = await approveTx0.wait();
                        console.log('Token0 授权已确认:', receipt0);
                    } catch (approveError) {
                        console.error('Token0 授权失败:', approveError);
                        console.log('完整错误对象:', JSON.stringify(approveError, (key, value) => 
                            key === 'provider' ? undefined : value, 2));
                        
                        if (approveError.code === 'ACTION_REJECTED') {
                            throw new Error('用户拒绝了 Token0 授权');
                        } else {
                            throw new Error(`Token0 授权失败: ${approveError.message || approveError}`);
                        }
                    }
                }

                // Token1 授权
                if (allowance1.lt(requiredAmount1)) {
                    console.log('正在授权 Token1...');
                    document.getElementById('addLiquidityResult').innerHTML = 
                        '<div class="info">请在 MetaMask 中确认 Token1 授权...</div>';
                    
                    try {
                        const approveTx1 = await token1Contract.approve(POOL_ADDRESS, requiredAmount1, {
                            gasLimit: 100000
                        });
                        console.log('Token1 授权交易已发送:', approveTx1.hash);
                        
                        document.getElementById('addLiquidityResult').innerHTML = 
                            '<div class="info">Token1 授权中，请等待确认...</div>';
                        
                        const receipt1 = await approveTx1.wait();
                        console.log('Token1 授权已确认:', receipt1);
                    } catch (approveError) {
                        console.error('Token1 授权失败:', approveError);
                        console.log('完整错误对象:', JSON.stringify(approveError, (key, value) => 
                            key === 'provider' ? undefined : value, 2));
                        
                        if (approveError.code === 'ACTION_REJECTED') {
                            throw new Error('用户拒绝了 Token1 授权');
                        } else {
                            throw new Error(`Token1 授权失败: ${approveError.message || approveError}`);
                        }
                    }
                }
                
                // 添加流动性
                console.log('正在添加流动性...');
                document.getElementById('addLiquidityResult').innerHTML = 
                    '<div class="info">请在 MetaMask 中确认添加流动性交易...</div>';
                
                try {
                    console.log('调用 poolContract.addLiquidity:', amount0.toString());
                    console.log('Pool 地址:', POOL_ADDRESS);
                    console.log('调用方法: addLiquidity');
                    console.log('参数: amount0 =', amount0.toString());
                    console.log('要求的 amount1 =', amount1.toString());
                    
                    // 调用修改后的 Pool 合约，现在需要自定义修改合约的 addLiquidity 方法
                    // 由于当前合约的 addLiquidity 方法不支持自定义 Token1 数量
                    // 这里首先需要检查合约是否支持这种调用方式
                    
                    const reserves = await poolContract.getReserves();
                    console.log('当前池子储备:', reserves);
                    
                    const tx = await poolContract.addLiquidity(amount0, {
                        gasLimit: 1000000  // 增加 gas 限制
                    });
                    
                    console.log('交易已发送:', tx.hash);
                    document.getElementById('addLiquidityResult').innerHTML = 
                        '<div class="info">交易已发送，等待确认...</div>';
                    
                    console.log('等待交易确认...');
                    const receipt = await tx.wait();
                    console.log('交易已确认!', receipt);
                    
                    document.getElementById('addLiquidityResult').innerHTML = 
                        '<div class="success">流动性添加成功！</div>';
                    
                    // 清空输入框
                    document.getElementById('amount0').value = '';
                    document.getElementById('amount1').value = '';
                    
                    // 更新池子信息
                    await updatePoolInfo();
                    console.log('===== 添加流动性流程完成 =====');
                } catch (txError) {
                    console.error('添加流动性交易失败:', txError);
                    console.log('完整错误对象:', JSON.stringify(txError, (key, value) => 
                        key === 'provider' ? undefined : value, 2));
                    
                    let errorMessage = '添加流动性失败';
                    
                    // 解析常见错误
                    if (txError.code === 'ACTION_REJECTED') {
                        errorMessage = '用户拒绝了交易';
                    } else if (txError.code === 'INSUFFICIENT_FUNDS') {
                        errorMessage = '账户余额不足以支付 gas 费用';
                    } else if (txError.code === 'UNPREDICTABLE_GAS_LIMIT') {
                        errorMessage = '无法预测 gas 限制，可能合约调用将失败';
                    } else if (txError.message) {
                        errorMessage = `${errorMessage}: ${txError.message}`;
                    }
                    
                    // 检查是否有更详细的错误信息
                    if (txError.error) {
                        console.log('交易错误详情:', txError.error);
                        if (txError.error.message) {
                            errorMessage = `${errorMessage}: ${txError.error.message}`;
                        }
                        if (txError.error.data) {
                            console.log('交易错误数据:', txError.error.data);
                        }
                    }
                    
                    document.getElementById('addLiquidityResult').innerHTML = 
                        `<div class="error">${errorMessage}</div>`;
                    
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('添加流动性总错误:', error);
                console.log('错误栈:', error.stack);
                
                let errorMessage = error.message || '未知错误';
                document.getElementById('addLiquidityResult').innerHTML = 
                    `<div class="error">添加流动性失败: ${errorMessage}</div>`;
            }
        }

        // 移除流动性
        async function removeLiquidity() {
            try {
                const lpAmount = document.getElementById('removeAmount').value;
                if (!lpAmount || lpAmount <= 0) {
                    throw new Error('请输入有效的 LP Token 数量');
                }

                const lpAmountWei = ethers.utils.parseEther(lpAmount);
                
                console.log('开始移除流动性...');
                console.log('输入的 LP Token 数量:', lpAmount);
                console.log('转换后的 Wei 数量:', lpAmountWei.toString());
                
                // 检查 LP Token 余额
                const lpBalance = await poolContract.balanceOf(userAddress);
                console.log('当前 LP Token 余额:', ethers.utils.formatEther(lpBalance));
                
                if (lpBalance.lt(lpAmountWei)) {
                    throw new Error(`LP Token 余额不足 (当前余额: ${ethers.utils.formatEther(lpBalance)} LP, 需要: ${lpAmount} LP)`);
                }

                // 调用合约移除流动性
                console.log('准备发送交易...');
                const tx = await poolContract.removeLiquidity(lpAmountWei, {
                    gasLimit: 500000  // 添加 gas 限制
                });
                console.log('交易已发送:', tx.hash);
                
                document.getElementById('removeLiquidityResult').innerHTML = 
                    '<div class="success">交易已发送，等待确认...</div>';
                
                // 等待交易确认
                console.log('等待交易确认...');
                const receipt = await tx.wait();
                console.log('交易已确认:', receipt);
                
                document.getElementById('removeLiquidityResult').innerHTML = 
                    '<div class="success">流动性已成功移除！</div>';
                
                // 更新池子信息
                await updatePoolInfo();
            } catch (error) {
                console.error('移除流动性失败:', error);
                let errorMessage = error.message;
                
                // 解析常见错误
                if (error.code === 'ACTION_REJECTED') {
                    errorMessage = '用户拒绝了交易';
                } else if (error.code === 'INSUFFICIENT_FUNDS') {
                    errorMessage = '账户余额不足以支付 gas 费用';
                } else if (error.message.includes('user rejected')) {
                    errorMessage = '用户取消了交易';
                }
                
                document.getElementById('removeLiquidityResult').innerHTML = 
                    `<div class="error">移除流动性失败: ${errorMessage}</div>`;
            }
        }

        // 代币交换
        async function swap() {
            try {
                const amount = ethers.utils.parseEther(document.getElementById('swapAmount').value);
                const tokenIn = document.getElementById('tokenIn').value;
                
                // 先授权代币
                const tokenContract = tokenIn === 'token0' ? token0Contract : token1Contract;
                await tokenContract.approve(POOL_ADDRESS, amount);
                
                // 执行交换
                const tx = await poolContract.swap(
                    tokenIn === 'token0' ? TOKEN0_ADDRESS : TOKEN1_ADDRESS,
                    amount,
                    tokenIn === 'token0' ? TOKEN1_ADDRESS : TOKEN0_ADDRESS
                );
                await tx.wait();
                
                document.getElementById('swapResult').innerHTML = 
                    '<div class="success">交换成功！</div>';
                updatePoolInfo();
            } catch (error) {
                console.error(error);
                document.getElementById('swapResult').innerHTML = 
                    '<div class="error">交换失败</div>';
            }
        }

        // 更新池子信息
        async function updatePoolInfo() {
            try {
                if (!poolContract || !token0Contract || !token1Contract || !userAddress) {
                    throw new Error('合约或用户地址未初始化');
                }

                console.log('开始获取池子储备...');
                try {
                    const [reserve0, reserve1] = await poolContract.getReserves();
                    console.log('池子储备:', { reserve0: reserve0.toString(), reserve1: reserve1.toString() });
                    
                    console.log('开始获取代币余额...');
                    const token0Balance = await token0Contract.balanceOf(userAddress);
                    const token1Balance = await token1Contract.balanceOf(userAddress);
                    console.log('代币余额:', { 
                        token0Balance: token0Balance.toString(), 
                        token1Balance: token1Balance.toString() 
                    });
                    
                    console.log('开始获取 LP Token 余额...');
                    const lpBalance = await poolContract.balanceOf(userAddress);
                    console.log('LP Token 余额:', lpBalance.toString());
                    
                    const formattedReserve0 = ethers.utils.formatEther(reserve0);
                    const formattedReserve1 = ethers.utils.formatEther(reserve1);
                    const formattedToken0Balance = ethers.utils.formatEther(token0Balance);
                    const formattedToken1Balance = ethers.utils.formatEther(token1Balance);
                    const formattedLpBalance = ethers.utils.formatEther(lpBalance);
                    
                    document.getElementById('poolInfo').innerHTML = `
                        <h3>池子储备</h3>
                        <p>Token0 储备: ${formattedReserve0} T0</p>
                        <p>Token1 储备: ${formattedReserve1} T1</p>
                        
                        <h3>您的余额</h3>
                        <p>Token0 余额: ${formattedToken0Balance} T0</p>
                        <p>Token1 余额: ${formattedToken1Balance} T1</p>
                        <p>LP Token 余额: ${formattedLpBalance} LP</p>
                        
                        <h3>价格信息</h3>
                        <p>Token0/Token1 价格: ${(Number(formattedReserve1) / Number(formattedReserve0)).toFixed(6)}</p>
                        <p>Token1/Token0 价格: ${(Number(formattedReserve0) / Number(formattedReserve1)).toFixed(6)}</p>
                    `;
                } catch (error) {
                    console.error('合约调用失败:', error);
                    throw error;
                }
            } catch (error) {
                console.error('更新池子信息失败:', error);
                console.error('错误详情:', {
                    message: error.message,
                    stack: error.stack,
                    poolContract: !!poolContract,
                    token0Contract: !!token0Contract,
                    token1Contract: !!token1Contract,
                    userAddress: userAddress
                });
                document.getElementById('poolInfo').innerHTML = 
                    `<div class="error">更新池子信息失败: ${error.message}</div>`;
            }
        }

        // 绑定事件监听器
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('addLiquidity').addEventListener('click', addLiquidity);
        document.getElementById('removeLiquidity').addEventListener('click', removeLiquidity);
        document.getElementById('swap').addEventListener('click', swap);
    </script>
</body>
</html> 