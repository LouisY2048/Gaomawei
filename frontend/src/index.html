<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>去中心化交易所</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        h2 {
            color: #333;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .error {
            color: red;
            margin-top: 5px;
        }
        .success {
            color: green;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>去中心化交易所</h1>
        
        <div class="section">
            <h2>连接钱包</h2>
            <button id="connectWallet">连接 MetaMask</button>
            <div id="walletAddress"></div>
        </div>

        <div class="section">
            <h2>添加流动性</h2>
            <div class="form-group">
                <label>Token0 数量:</label>
                <input type="number" id="amount0" placeholder="输入数量">
            </div>
            <div class="form-group">
                <label>Token1 数量:</label>
                <input type="number" id="amount1" placeholder="输入数量">
            </div>
            <button id="addLiquidity">添加流动性</button>
            <div id="addLiquidityResult"></div>
        </div>

        <div class="section">
            <h2>移除流动性</h2>
            <div class="form-group">
                <label>LP Token 数量:</label>
                <input type="number" id="removeAmount" placeholder="输入数量">
            </div>
            <button id="removeLiquidity">移除流动性</button>
            <div id="removeLiquidityResult"></div>
        </div>

        <div class="section">
            <h2>代币交换</h2>
            <div class="form-group">
                <label>输入代币数量:</label>
                <input type="number" id="swapAmount" placeholder="输入数量">
            </div>
            <div class="form-group">
                <label>选择输入代币:</label>
                <select id="tokenIn">
                    <option value="token0">Token0</option>
                    <option value="token1">Token1</option>
                </select>
            </div>
            <button id="swap">交换</button>
            <div id="swapResult"></div>
        </div>

        <div class="section">
            <h2>池子信息</h2>
            <div id="poolInfo"></div>
        </div>
    </div>

    <script>
        // 等待 ethers 加载完成
        window.addEventListener('load', function() {
            if (typeof ethers === 'undefined') {
                console.error('ethers 库加载失败');
                document.getElementById('walletAddress').innerHTML = 
                    '<div class="error">ethers 库加载失败，请刷新页面重试</div>';
                return;
            }
        });

        // 合约地址和 ABI 需要部署后更新
        const POOL_ADDRESS = "0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0";
        const TOKEN0_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
        const TOKEN1_ADDRESS = "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512";
        
        let provider, signer, poolContract, token0Contract, token1Contract;
        let userAddress;

        // 连接钱包
        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    // 请求用户授权
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    // 创建 provider
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    
                    // 获取 signer
                    signer = provider.getSigner();
                    
                    // 获取用户地址
                    userAddress = await signer.getAddress();
                    
                    // 显示连接成功信息
                    document.getElementById('walletAddress').innerHTML = 
                        `<div class="success">已连接钱包: ${userAddress}</div>`;
                    
                    // 初始化合约
                    await initializeContracts();
                } else {
                    alert('请安装 MetaMask!');
                }
            } catch (error) {
                console.error('连接钱包失败:', error);
                document.getElementById('walletAddress').innerHTML = 
                    `<div class="error">连接钱包失败: ${error.message}</div>`;
            }
        }

        // 初始化合约
        async function initializeContracts() {
            const poolABI = [
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "token0",
                            "type": "address"
                        },
                        {
                            "internalType": "address",
                            "name": "token1",
                            "type": "address"
                        }
                    ],
                    "stateMutability": "nonpayable",
                    "type": "constructor"
                },
                {
                    "inputs": [
                        {
                            "internalType": "uint256",
                            "name": "amount0",
                            "type": "uint256"
                        }
                    ],
                    "name": "addLiquidity",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "tokenIn",
                            "type": "address"
                        },
                        {
                            "internalType": "uint256",
                            "name": "amountIn",
                            "type": "uint256"
                        },
                        {
                            "internalType": "address",
                            "name": "tokenOut",
                            "type": "address"
                        }
                    ],
                    "name": "swap",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "uint256",
                            "name": "lpAmount",
                            "type": "uint256"
                        }
                    ],
                    "name": "removeLiquidity",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "getReserves",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        },
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "account",
                            "type": "address"
                        }
                    ],
                    "name": "balanceOf",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "totalSupply",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                }
            ];

            const tokenABI = [
                {
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "name",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "symbol",
                            "type": "string"
                        }
                    ],
                    "stateMutability": "nonpayable",
                    "type": "constructor"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "spender",
                            "type": "address"
                        },
                        {
                            "internalType": "uint256",
                            "name": "value",
                            "type": "uint256"
                        }
                    ],
                    "name": "approve",
                    "outputs": [
                        {
                            "internalType": "bool",
                            "name": "",
                            "type": "bool"
                        }
                    ],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "account",
                            "type": "address"
                        }
                    ],
                    "name": "balanceOf",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                }
            ];
            
            poolContract = new ethers.Contract(POOL_ADDRESS, poolABI, signer);
            token0Contract = new ethers.Contract(TOKEN0_ADDRESS, tokenABI, signer);
            token1Contract = new ethers.Contract(TOKEN1_ADDRESS, tokenABI, signer);
            
            // 更新池子信息
            updatePoolInfo();
        }

        // 添加流动性
        async function addLiquidity() {
            try {
                const amount0 = ethers.utils.parseEther(document.getElementById('amount0').value);
                const amount1 = ethers.utils.parseEther(document.getElementById('amount1').value);
                
                // 先授权代币
                await token0Contract.approve(POOL_ADDRESS, amount0);
                await token1Contract.approve(POOL_ADDRESS, amount1);
                
                // 添加流动性
                const tx = await poolContract.addLiquidity(amount0);
                await tx.wait();
                
                document.getElementById('addLiquidityResult').innerHTML = 
                    '<div class="success">流动性添加成功！</div>';
                updatePoolInfo();
            } catch (error) {
                console.error(error);
                document.getElementById('addLiquidityResult').innerHTML = 
                    '<div class="error">添加流动性失败</div>';
            }
        }

        // 移除流动性
        async function removeLiquidity() {
            try {
                const amount = ethers.utils.parseEther(document.getElementById('removeAmount').value);
                const tx = await poolContract.removeLiquidity(amount);
                await tx.wait();
                
                document.getElementById('removeLiquidityResult').innerHTML = 
                    '<div class="success">流动性移除成功！</div>';
                updatePoolInfo();
            } catch (error) {
                console.error(error);
                document.getElementById('removeLiquidityResult').innerHTML = 
                    '<div class="error">移除流动性失败</div>';
            }
        }

        // 代币交换
        async function swap() {
            try {
                const amount = ethers.utils.parseEther(document.getElementById('swapAmount').value);
                const tokenIn = document.getElementById('tokenIn').value;
                
                // 先授权代币
                const tokenContract = tokenIn === 'token0' ? token0Contract : token1Contract;
                await tokenContract.approve(POOL_ADDRESS, amount);
                
                // 执行交换
                const tx = await poolContract.swap(
                    tokenIn === 'token0' ? TOKEN0_ADDRESS : TOKEN1_ADDRESS,
                    amount,
                    tokenIn === 'token0' ? TOKEN1_ADDRESS : TOKEN0_ADDRESS
                );
                await tx.wait();
                
                document.getElementById('swapResult').innerHTML = 
                    '<div class="success">交换成功！</div>';
                updatePoolInfo();
            } catch (error) {
                console.error(error);
                document.getElementById('swapResult').innerHTML = 
                    '<div class="error">交换失败</div>';
            }
        }

        // 更新池子信息
        async function updatePoolInfo() {
            try {
                if (!poolContract || !token0Contract || !token1Contract || !userAddress) {
                    throw new Error('合约或用户地址未初始化');
                }

                console.log('开始获取池子储备...');
                const [reserve0, reserve1] = await poolContract.getReserves();
                console.log('池子储备:', { reserve0: reserve0.toString(), reserve1: reserve1.toString() });
                
                console.log('开始获取代币余额...');
                const token0Balance = await token0Contract.balanceOf(userAddress);
                const token1Balance = await token1Contract.balanceOf(userAddress);
                console.log('代币余额:', { 
                    token0Balance: token0Balance.toString(), 
                    token1Balance: token1Balance.toString() 
                });
                
                console.log('开始获取 LP Token 余额...');
                const lpBalance = await poolContract.balanceOf(userAddress);
                console.log('LP Token 余额:', lpBalance.toString());
                
                const formattedReserve0 = ethers.utils.formatEther(reserve0);
                const formattedReserve1 = ethers.utils.formatEther(reserve1);
                const formattedToken0Balance = ethers.utils.formatEther(token0Balance);
                const formattedToken1Balance = ethers.utils.formatEther(token1Balance);
                const formattedLpBalance = ethers.utils.formatEther(lpBalance);
                
                document.getElementById('poolInfo').innerHTML = `
                    <h3>池子储备</h3>
                    <p>Token0 储备: ${formattedReserve0} T0</p>
                    <p>Token1 储备: ${formattedReserve1} T1</p>
                    
                    <h3>您的余额</h3>
                    <p>Token0 余额: ${formattedToken0Balance} T0</p>
                    <p>Token1 余额: ${formattedToken1Balance} T1</p>
                    <p>LP Token 余额: ${formattedLpBalance} LP</p>
                    
                    <h3>价格信息</h3>
                    <p>Token0/Token1 价格: ${(Number(formattedReserve1) / Number(formattedReserve0)).toFixed(6)}</p>
                    <p>Token1/Token0 价格: ${(Number(formattedReserve0) / Number(formattedReserve1)).toFixed(6)}</p>
                `;
            } catch (error) {
                console.error('更新池子信息失败:', error);
                console.error('错误详情:', {
                    message: error.message,
                    stack: error.stack,
                    poolContract: !!poolContract,
                    token0Contract: !!token0Contract,
                    token1Contract: !!token1Contract,
                    userAddress: userAddress
                });
                document.getElementById('poolInfo').innerHTML = 
                    `<div class="error">更新池子信息失败: ${error.message}</div>`;
            }
        }

        // 绑定事件监听器
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('addLiquidity').addEventListener('click', addLiquidity);
        document.getElementById('removeLiquidity').addEventListener('click', removeLiquidity);
        document.getElementById('swap').addEventListener('click', swap);
    </script>
</body>
</html> 